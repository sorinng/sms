<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>문자 발송 페이지</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Handsontable -->
<link href="https://cdn.jsdelivr.net/npm/handsontable@12.4.0/dist/handsontable.full.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/handsontable@12.4.0/dist/handsontable.full.min.js"></script>

<!-- QRCode JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body class="bg-gray-100 min-h-screen">

<div class="max-w-3xl mx-auto mt-8 bg-white shadow-xl rounded-xl p-8">

  <!-- 제목 + QR 생성 버튼 -->
  <div class="flex justify-between items-center mb-8">
    <h1 class="text-3xl font-bold">📱 문자 발송 관리</h1>

    <button id="makeQR"
      class="bg-green-600 hover:bg-green-700 text-white px-5 py-3 rounded-lg shadow font-semibold">
      QR 코드 생성
    </button>
  </div>

  <!-- 연락처 입력 -->
  <h2 class="text-xl font-semibold mb-2">연락처 입력</h2>
  <p class="text-gray-500 mb-3">최대 50명 입력 가능 (15명까지만 화면에 표시)</p>

  <div id="hot" class="mb-8"></div>

  <!-- 문자 내용 입력 -->
  <h2 class="text-xl font-semibold mb-2">문자 내용</h2>
  <textarea id="msgText" class="w-full h-32 p-3 border rounded-lg mb-8
             focus:outline-none focus:ring-2 focus:ring-blue-600"
    placeholder="예: 안녕하세요. 일정 안내드립니다."></textarea>

  <!-- 사람별 문자 발송 버튼 -->
  <h2 class="text-xl font-semibold mb-4">문자 보내기</h2>
  <div id="buttonArea" class="space-y-3"></div>

  <!-- QR 출력 위치 -->
  <div id="qrArea" class="text-center mt-8"></div>

</div>


<script>
  // -----------------------------
  // 1. 50행 빈 데이터 만들기
  // -----------------------------
  const emptyData = Array.from({ length: 50 }, () => ["", ""]);


  // -----------------------------
  // 2. Handsontable 초기화 (15행 높이 지정)
  // -----------------------------
  const container = document.getElementById("hot");

  const hot = new Handsontable(container, {
    data: emptyData,
    colHeaders: ["이름", "전화번호"],
    rowHeaders: true,
    contextMenu: true,
    width: "100%",
    height: 400,    // → 약 15행 높이
    licenseKey: "non-commercial-and-evaluation"
  });


  // -----------------------------
  // 3. 사람별 문자 보내기 버튼 렌더링
  // -----------------------------
  function renderButtons() {
    const area = document.getElementById("buttonArea");
    area.innerHTML = "";

    const rows = hot.getData();
    const message = document.getElementById("msgText").value.trim();

    rows.forEach(row => {
      const name = row[0];
      const phone = row[1];

      if (!name || !phone) return;

      // 이미 문자 보냈으면 숨김
      if (localStorage.getItem("sent_" + name)) return;

      const btn = document.createElement("button");
      btn.className =
        "w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg shadow text-lg font-semibold";
      btn.innerText = `${name}에게 문자 보내기`;

      btn.onclick = () => {
        if (!message) {
          alert("문자 내용을 입력하세요!");
          return;
        }

        const smsUrl = `sms:${phone}?body=${encodeURIComponent(message)}`;

        // 문자 보낸 사람 저장
        localStorage.setItem("sent_" + name, "true");

        // 문자 앱 실행
        window.location.href = smsUrl;

        // 버튼 다시 렌더링
        setTimeout(() => renderButtons(), 500);
      };

      area.appendChild(btn);
    });
  }

  // 페이지 로드시 자동 생성
  setTimeout(renderButtons, 300);

  document.getElementById("msgText").addEventListener("input", renderButtons);


  // -----------------------------
  // 4. QR 코드 생성 기능
  // -----------------------------
  document.getElementById("makeQR").addEventListener("click", () => {
    const qrArea = document.getElementById("qrArea");
    qrArea.innerHTML = `
      <h3 class="text-xl font-semibold mb-3">이 페이지로 접속하는 QR 코드</h3>
      <div id="qrcode" class="flex justify-center"></div>
    `;

    // 현재 페이지 URL 자동 불러오기
    const pageURL = window.location.href;

    new QRCode(document.getElementById("qrcode"), {
      text: pageURL,
      width: 220,
      height: 220
    });
  });

</script>

</body>
</html>
